<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>GPX2GeoJSON</title>
<link rel='stylesheet' href='common.css'>
<style>
.t-c td { text-align: center; }
</style>
</head>
<body>
<div id="contents">
<div class="menu">
<ul>
<li><a href="https://anineco.nyanta.jp/">電脳覚書</a> &gt;</li>
<li><a href="https://anineco.nyanta.jp/bbs/">掲示板</a> |</li>
<li><a href="https://github.com/anineco/py-gpx2geojson">GitHub</a> |</li>
<li><a href="https://anineco.nyanta.jp/gps-track-maps/">Web地図を利用したGPSログ表示</a></li>
</ul>
</div><!-- end menu -->
<h1>GPX2GeoJSON（GPX→GeoJSONコンバータ）Python版</h1>
<ul>
  <li>更新情報（2021-03-01）：GPX2GeoJSON Ver.2.0 公開。スクリプト言語をPerlからPython 3に変更。
  <img src="image/new.gif" alt="NEW" height="11" width="20"></li>
<li>オリジナルのGPX2GeoJSON（Perl版）のサイトは<a href="https://anineco.github.io/gpx2geojson/">こちら</a>。</li>
<li>このサイトに関するご意見・ご質問・ご要望は、<a href="http://anineco.nyanta.jp/bbs/">サポート掲示板</a>へお願いします。</li>
</ul>
<h2>GPX2GeoJSONとは？</h2>
<p>GPX2GeoJSON（GPX→GeoJSONコンバータ）は、カシミール3Dで保存した<b>GPXファイル</b>（拡張子 .gpx）を、各種ウェブ地図に上乗せして表示できる<b>GeoJSONファイル</b>（拡張子 .geojson）に変換するデスクトップアプリケーションです。Windows 10、macOS、Linuxで動作します。2008年1月に公開した<a href="https://anineco.nyanta.jp/gpx2jsgi/gpx2jsgi.html">GPX2JSGI</a>（GPX→KMLコンバータ）と同様、作者のホームページ（<a href="https://anineco.org/">あにねこ登山日誌</a>）の山行記録に添えるルート地図を作成するためのユーティリティとして開発したものです。当初は上乗せデータとしてJSGIファイル、2013年12月からはKMLファイルを利用していましたが、主流になりつつあるGeoJSONファイルへ2019年2月に移行しました。その際に、コンセプトはGPX2JSGIから引き継ぎつつ、全く新規に開発したアプリケーションです。Ver. 1.0より、KMLファイルやGPXファイルの出力機能を追加しました。Ver. 2.0よりスクリプト言語をPerlからPython 3に変更しました。</p>
<h3>主な機能と特徴</h3>
<ul>
<li>カシミール3Dで保存したGPXファイルを、国土地理院が提案する<a href="https://github.com/gsi-cyberjapan/geojson-with-style-spec">スタイルつきGeoJSON規約</a>に準拠したGeoJSONファイル、または<a href="https://maps.gsi.go.jp/development/sakuzu_siyou.html">KMLウェブ地図プロファイル</a>に準拠したKMLファイルに変換します。</li>
<li>グラフィカルユーザインタフェース（GUI）を備え、ファイル形式の中身について知らなくても、簡単に変換できます。</li>
<li>変換したGeoJSONファイルやKMLファイルは、<a href="https://maps.gsi.go.jp/">地理院地図</a>にドラッグ＆ドロップして、すぐに表示を確認することができます。</li>
<li>複数のGPXファイルをまとめて、単一のファイルに変換します（マージ機能）。</li>
<li>変換の際、トラックポイントをcross track errorアルゴリズムを用いて間引くことができます（GPSBabelを利用）。</li>
<li>GPX2GeoJSONはPython 3で記述され、ソースコードはGitHubで公開しています。</li>
<li>実行には、Python 3とGPSBabelが必要です。Windows 10、macOS、Linuxで動作します。</li>
</ul>
<h3>ギャラリー</h3>
<p>変換したGPXファイル、KMLファイル、GeoJSONファイルは上乗せデータとしてWeb地図で表示することができます。図1はOpenLayers 6を用いてサイトに埋め込み表示を行なった例です。なお、GPXファイルはZ座標も保持しているため、他の二つと比べてファイルサイズが大きくなっています。</p>
<table style="margin:1em auto;" class="t-c">
<tbody>
<tr><td><iframe width="640" height="480" src="omap_gpx.html"></iframe></td></tr>
<tr><td>(a) GPXファイル（26348 bytes）</td></tr>
<tr><td><iframe width="640" height="480" src="omap_kml.html"></iframe></td></tr>
<tr><td>(b) KMLファイル（9031 bytes）</td></tr>
<tr><td><iframe width="640" height="480" src="omap_geojson.html"></iframe></td></tr>
<tr><td>(c) GeoJSONファイル（8965 bytes）</td></tr>
<tr><td>図1 OpenLayers 6を用いた上乗せデータのWeb地図での表示例</td></tr>
</tbody>
</table>
<h3>動作環境</h3>
<p>Windows 10、macOS、Linuxで動作します。実行に際してはPython 3、Pythonのlxmlライブラリ、GPSBabelが必要です。<p>
<h3>著作権について</h3>
<p>GPX2GeoJSONのソフトウェアおよび付属文書の著作権は、作者のあにねこ（anineco@nifty.com）が保持します。本ソフトウェアはMITライセンスに基づいて無償で提供され、複製を入手した人は商用・非商用を問わず自由に使用、複写、変更、結合、掲載、配布することができます。本ソフトウェアの複製または変更した物を掲載、配布する場合は、ソースコード中の著作権表示は削除できません。</p>
<h3>免責事項</h3>
<p>本ソフトウェアは無保証です。特に、変換結果のデータ形式の正当性・正確性については保証しません。作者は本ソフトウェアに起因するいかなる義務（サポートを含む）についても責任を負いません。</p>
<h2>導入方法</h2>
<h3>準備</h3>
<p>Windowsの場合、以下の手順でPython 3, lxml、GPSBabelのインストールが必要です。macOS、Linuxについては、それぞれ、パッケージ管理ソフトウェアを用いて簡単にインストール可能なので、説明は省略します。</p>
<h4>Python 3</h4>
<p>公式サイト<a href="https://www.python.org/">https://www.python.org/</a>から最新版（2021-03-01現在、python-3.9.2-embed-amd64.zip）をダウンロードして、インストールします。<a href="https://www.python.jp/install/windows/install.html">Windows版Pythonのインストール</a>が参考になります。インストールの際、"Add Python 3.x to PATH"にチェックを入れて下さい。</p>
<h4>lxml</h4>
<p>コマンドプロンプトを起動し、次のコマンドを実行します。</p>
<pre>pip3 install lxml</pre>
<p>追加インストールされているライブラリとそのバージョンは、次のコマンドで一覧表示できます。</p>
<pre>pip3 list</pre>
<p><code>lxml</code>のバージョンは<code>&gt;=4.5</code>であることが必要です。</p>
<h4>GPSBabel</h4>
<p>公式サイト<a href="https://www.gpsbabel.org/">https://www.gpsbabel.org/</a>から最新版（2021-03-01現在、GPSBabel-1.7.0-Setup-exe）をダウンロードしてインストールします。インストール先は通常<code>'C:\Program Files (x86)\GPSBabel'</code>です。これと異なる場合は、<code>gpsbabel.py</code>の中で指定されている<code>gpsbabel.exe</code>のパスを書き換える必要があります。</p>
<h3>インストール</h3>
<div style="float:right;text-align:center;font-size:small;padding:5px;margin:5px;border:dashed 2px gray;background:white;"><img src="image/github.png" width="359" height="302"><br>図2 GitHubダウンロード画面</div>
<p>まず、GitHubからGPX2GeoJSONの最新版をダウンロードします。<a href="https://github.com/anineco/py-gpx2geojson">https://github.com/anineco/py-gpx2geojson</a>にアクセスするとGPX2GeoJSONのリポジトリ画面が開きます。<span style="font-size:small;background:green;color:white;padding:2px;border-radius:2px;">↓Code</span>をクリックすると図2の小窓が開き、続いて<span style="color:blue;">Download ZIP</span>をクリックするとダウンロードが始まります。</p>
<p>ダウンロードしたZIPファイルを適当なフォルダの下で展開すると、下記のようにファイルが配置されます。赤字の<code><b>gpx2geojson.pyw</b></code>が、メインのGUIアプリケーションです。</p>
<div class="src" style="clear:both;">
<div>ディレクトリ構成図</div>
<pre>
py-gpx2geojson
├── <b>gpx2geojson.pyw</b>   （GUIアプリケーション）
├── gpx2geojson_cli.py（CUIアプリケーション）
├── iconlut.py        （アイコン変換表）
├── iconlut_anineco.py（アイコン変換表：あにねこ登山日誌専用）
├── gpsbabel.py       （GPSBabel呼び出し）
├── extensions.py     （カシミール3Dで拡張されたGPXの読み取り）
├── togeojson.py      （geojsonへの変換ルーチン）
├── tokml.py          （KMLへの変換ルーチン）
├── config.py         （動作パラメータ定義）
├── const.pl          （共通定数定義）
├── docs/*            （GitHub Pages）
└── test/*            （テスト用データ）
</pre>
</div><!-- .src -->
<h3>アンインストール</h3>
<p>GPX2GeoJSONのアンインストールは、展開したフォルダをまるごと削除して下さい。GPX2GeoJSONを一度起動して終了すると、ホームフォルダ直下に.gpx2geojsonというファイルが作成されます。アンインストールの際には、このファイルも削除して差し支えありません。</p>
<h2>操作方法</h2>
<h3>起動</h3>
<p><code>gpx2geojson.pyw</code>（<img src="image/python.png" width="16" height="16">のアイコン）をクリックすると、GUIが起動して図3のような窓が開きます。</p>
<p style="text-align:center;"><img src="image/gui1.png" alt="図3" height="302" width="621"><br>図3 GUI画面</p>
<h3>入出力ファイル指定</h3>
<p>変換したいGPXファイル（1個以上）を、右側の『←追加』ボタンを押してファイル選択ダイアログを開き、「GPXファイル」のリストに追加します。ファイル選択ダイアログでは、ControlキーやShiftキーを押しながらクリックすることにより、複数ファイルを同時に選択することができます。リスト中のファイルをマウスで選択して『除外』ボタンを押すと、リストから取り除くことが出来ます。また、『クリア』ボタンを押すと、リストは空になります。</p>
<p>出力形式をGPX、KML、GeoJSONの中から一つ選択します。</p>
<p>次に、「出力ファイル」を右側の『選択』ボタンを押して指定します。拡張子を指定しなかった場合は、出力形式に応じて自動的に付加されます。</p>
<h3>線の透過率、線種、線幅の指定</h3>
<p>線の透過率は元のGPXファイルにはない情報です。スピンボックスで0.0〜1.0の値を0.1刻みで指定します。線種と線幅は元のGPXファイルに含まれる情報です。これをそのまま出力ファイルに反映させる場合には、『GPX』にチェックを入れます。その他の場合、指定した値で上書きされます。</p>
<h3>トラックポイント間引き設定</h3>
<p>トラックポイントを間引く場合は、「軌跡を間引く」欄にチェックを入れて下さい。すると、その下の「許容誤差」のスピンボックスが編集可能になるので、正の数値（単位はkm）を設定します。間引きには、cross track errorアルゴリズムを用いたGPSBabelのSimplifyフィルタを利用しています。許容誤差を大きくすると間引かれる点数が増えますが、軌跡の細部の形状が失われるので、調節が必要です。最初は初期設定値（0.005km）で試してみて下さい。</p>
<p style="text-align:center;"><img src="image/gui2.png" alt="図4" height="302" width="621"><br>図4 変換準備完了後のGUI画面</p>
<h3>変換実行</h3>
<p>全ての必要項目を設定したのちに『変換』ボタンを押すと、変換結果が「出力ファイル」で指定したファイルに出力されます。変換が成功すると、変換後のトラックポイント数が「軌跡点数」の欄に表示されます。『終了』ボタンを押すと、プログラムを終了します。</p>
<h2>変換仕様</h2>
<p>変換仕様については、<a href="https://anineco.nyanta.jp/gpx2jsgi/gpx2jsgi.html">GPX2JSGI</a>の仕様をほぼそのまま踏襲しています。</p>
<h3>ウェイポイント</h3>
<p>カシミール3Dの「ウェイポイント/ルートポイントのプロパティ」（図5）の設定項目が、地理院地図でどのように表示されるかを説明します。</p>
<p style="text-align:center;"><img src="image/wptprop.png" alt="図5" height="343" width="403"><br>図5 ウェイポイント/ルートポイントのプロパティ</p>
<ul>
  <li><strong>アイコン</strong>：カシミール3Dで指定したアイコンは、GPX形式の中では「コード番号」で記録されます。GPX2GeoJSONはiconlut.pyの設定に基づいて、コード番号を対応するシンボル画像のURLに変換します。配布しているiconlut.pyの内容は簡単なPythonスクリプトで、次のようなものです。
<div class="src">
<div>iconlut.py</div>
<pre>#!/usr/bin/env python3
# -*- coding: utf-8 -*-

def url(icon):
    return 'https://map.jpn.org/icon/' + icon + '.png'

def size(icon):
    return [24, 24]

def anchor(icon):
    return [12, 12]

# __END__
</pre>
</div><!-- .src -->
この設定では、<code>https://map.jpn.org/</code>に設置済のシンボル画像にアクセスします。コード番号とシンボル画像の対応を<a href="https://map.jpn.org/iconlut.xml">アイコン変換表</a>に示します。この画像セットは、カシミール3Dのアイコンの全てに対応しています。</li>
  <li><strong>名前</strong>、<strong>GPSでの備考</strong>：地理院地図において、シンボル（点型データ）にマウスポインタを重ねると、ポップアップ窓で表示されます。GPSでの備考にはシンボルの属性情報を「項目名1=値1,項目名2=値2,…」のように項目名と値を「=」（イコール）で接続し、カンマ区切りで列挙して記述します。</li>
</ul>
<h3>ルート</h3>
<p>カシミール3Dの「ルートデータプロパティ」（図6）の設定項目が、地理院地図でどのように表示されるかを説明します。</p>
<p style="text-align:center;"><img src="image/rteprop.png" alt="図6" height="232" width="455"><br>図6 ルートデータプロパティ</p>
<ul>
<li><strong>表示色</strong>：カシミール3Dで指定した色で表示されます。透過率はGPX2GeoJSONで変換する際に指定します。</li>
<li><strong>線幅</strong>：カシミール3Dで指定した幅（1〜9）を地図上の幅（単位はピクセル）として表示します。地図の縮尺を変えても線幅は変化しません。</li>
<li><strong>線種</strong>：カシミール3Dで指定した種類のうち、実線、短長の破線、点線、一点鎖線、二点鎖線が表示可能です。</li>
</ul>
<p>カシミール3Dでは、ルート上の各ポイントに対しても図4の「ウェイポイントのプロパティ」を開いて、全く同様のプロパティを設定することができます。ルートポイントもウェイポイントと同様にGeoJSON形式に変換されました。ただし、アイコンが「地名」グループの「なし」（コード番号903001）のルートポイントは例外で、変換されません（「なし」アイコンのウェイポイントは変換されます）。ルートポイントを変換したくない場合は、アイコンを「なし」に設定して下さい。複数のルートポイントを選択してから「ウェイポイントのプロパティ」を開くと、アイコンの一括変更が可能です。</p>
<h3>トラック</h3>
<p>カシミール3Dの「トラックデータプロパティ」（図7）の設定項目が、地理院地図でどのように表示されるかを説明します。</p>
<p style="text-align:center;"><img src="image/trkprop.png" alt="図7" height="235" width="494"><br>図7 トラックデータプロパティ</p>
<ul>
<li><strong>表示色</strong>、<strong>線幅</strong>、<strong>線種</strong>：ルートの場合と同様です。</li>
<li><strong>アイコン</strong>：トラックデータに指定したアイコンは変換対象外です。</li>
</ul>
<h2><a name="history">更新履歴</a></h2>
<table class="base">
  <tbody>
    <tr>
      <td valign="top" class="nowrap;">2021-03-01</td>
      <td valign="top">GPX2GeoJSON Ver.2.0 公開。スクリプト言語をPerlからPython 3に変更。</td>
    </tr>
    <tr>
      <td valign="top" class="nowrap;">2020-07-07</td>
      <td valign="top">GPX2GeoJSON Ver.1.0 公開。GPX、KMLファイル出力機能を追加。</td>
    </tr>
    <tr>
      <td valign="top" class="nowrap;">2019-07-07</td>
      <td valign="top">GPX2GeoJSON Ver.0.9 公開。</td>
    </tr>
  </tbody>
</table>
<hr>
<address>&copy; 2019-2021 <a href="https://anineco.nyanta.jp/">あにねこ電脳覚書</a></address>
</div><!-- #contents -->
</body>
</html>
